
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonghuaWave - Admin Panel</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <style>
        /* Admin panel specific styles */
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            background-color: #2c3e50;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
        }
        .admin-actions {
            display: flex;
            gap: 10px;
        }
        .admin-content {
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        .form-control:focus {
            border-color: #3498db;
            outline: none;
        }
        textarea.form-control {
            min-height: 150px;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background 0.3s;
        }
        .btn-primary {
            background-color: #3498db;
            color: white;
        }
        .btn-primary:hover {
            background-color: #2980b9;
        }
        .btn-danger {
            background-color: #e74c3c;
            color: white;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .data-table th, .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        .data-table th {
            background-color: #f9f9f9;
            font-weight: 600;
        }
        .data-table tr:hover {
            background-color: #f5f5f5;
        }
        .action-buttons {
            display: flex;
            gap: 10px;
        }
        .tab-navigation {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        .tab-button {
            padding: 10px 20px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            color: #7f8c8d;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab-button.active {
            border-bottom: 2px solid #3498db;
            color: #3498db;
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .notification {
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        .notification.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .notification.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            display: none;
        }
        .loading i {
            font-size: 24px;
            animation: spin 1s infinite linear;
        }
        .thumbnail-preview {
            max-width: 100px;
            max-height: 100px;
            margin-top: 10px;
        }
        .tags-input {
            width: 100%;
            display: inline-block;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin-bottom: 10px;
        }
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 5px;
        }
        .tag {
            display: inline-block;
            background-color: #e0e0e0;
            padding: 5px 10px;
            border-radius: 15px;
            margin-right: 5px;
        }
        .tag-remove {
            margin-left: 5px;
            cursor: pointer;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>DonghuaWave</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="index.html">Home</a></li>
                    <li><a href="admin.html" class="active">Admin Panel</a></li>
                </ul>
            </nav>
            <div class="user-actions">
                <a href="login-admin.html" class="login-btn" id="adminLogoutButton">Logout</a>
            </div>
        </div>
    </header>

    <div class="admin-container">
        <div class="admin-header">
            <h1>Admin Dashboard</h1>
            <div class="admin-actions">
                <button class="btn btn-primary" id="newDonghuaButton">Add New Donghua</button>
            </div>
        </div>

        <div class="notification" id="notification"></div>
        
        <div class="admin-content">
            <div class="tab-navigation">
                <button class="tab-button active" data-tab="donghua">Manage Donghua</button>
                <button class="tab-button" data-tab="episodes">Manage Episodes</button>
                <button class="tab-button" data-tab="users">Manage Users</button>
            </div>
            
            <div class="loading" id="loading">
                <i class="fas fa-spinner"></i> Loading...
            </div>
            
            <!-- Donghua Tab -->
            <div class="tab-content active" id="donghua-tab">
                <table class="data-table" id="donghuaTable">
                    <thead>
                        <tr>
                            <th>Title</th>
                            <th>Year</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Donghua data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Episodes Tab -->
            <div class="tab-content" id="episodes-tab">
                <div id="episodeSelectionContainer">
                    <div class="form-group">
                        <label for="donghuaSelect">Select Donghua:</label>
                        <select class="form-control" id="donghuaSelect">
                            <option value="">-- Select Donghua --</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" id="addEpisodeButton" style="display:none;">Add New Episode</button>
                </div>
                
                <table class="data-table" id="episodesTable" style="display:none;">
                    <thead>
                        <tr>
                            <th>Episode #</th>
                            <th>Title</th>
                            <th>Duration</th>
                            <th>Premium</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Episodes data will be loaded here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Users Tab -->
            <div class="tab-content" id="users-tab">
                <table class="data-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Joined Date</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Users data will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Donghua Form Modal -->
    <div id="donghuaFormModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
        <div style="background-color:white; margin:50px auto; padding:20px; border-radius:5px; max-width:700px; max-height:80vh; overflow-y:auto;">
            <h2 id="modalTitle">Add New Donghua</h2>
            <form id="donghuaForm">
                <input type="hidden" id="donghuaId">
                <div class="form-group">
                    <label for="title">Title*</label>
                    <input type="text" class="form-control" id="title" required>
                </div>
                <div class="form-group">
                    <label for="year">Year</label>
                    <input type="number" class="form-control" id="year">
                </div>
                <div class="form-group">
                    <label for="status">Status</label>
                    <select class="form-control" id="status">
                        <option value="ongoing">Ongoing</option>
                        <option value="completed">Completed</option>
                        <option value="upcoming">Upcoming</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea class="form-control" id="description"></textarea>
                </div>
                <div class="form-group">
                    <label for="genre">Genre (Type and press Enter)</label>
                    <input type="text" class="tags-input" id="genreInput" placeholder="Action, Fantasy, etc.">
                    <div class="tags-container" id="genreTags"></div>
                    <input type="hidden" id="genreValues">
                </div>
                <div class="form-group">
                    <label for="posterUrl">Poster URL</label>
                    <input type="text" class="form-control" id="posterUrl">
                    <img id="posterPreview" class="thumbnail-preview" style="display:none;">
                </div>
                <div class="form-group" style="display:flex; justify-content:space-between;">
                    <button type="button" class="btn btn-danger" id="cancelDonghuaButton">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Episode Form Modal -->
    <div id="episodeFormModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color:rgba(0,0,0,0.5); z-index:1000;">
        <div style="background-color:white; margin:50px auto; padding:20px; border-radius:5px; max-width:700px; max-height:80vh; overflow-y:auto;">
            <h2 id="episodeModalTitle">Add New Episode</h2>
            <form id="episodeForm">
                <input type="hidden" id="episodeId">
                <input type="hidden" id="episodeDonghuaId">
                <div class="form-group">
                    <label for="episodeNumber">Episode Number*</label>
                    <input type="number" class="form-control" id="episodeNumber" required>
                </div>
                <div class="form-group">
                    <label for="episodeTitle">Title*</label>
                    <input type="text" class="form-control" id="episodeTitle" required>
                </div>
                <div class="form-group">
                    <label for="duration">Duration (minutes)</label>
                    <input type="number" class="form-control" id="duration">
                </div>
                <div class="form-group">
                    <label for="isPremium">Premium Content</label>
                    <select class="form-control" id="isPremium">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="thumbnailUrl">Thumbnail URL</label>
                    <input type="text" class="form-control" id="thumbnailUrl">
                    <img id="thumbnailPreview" class="thumbnail-preview" style="display:none;">
                </div>
                <div class="form-group">
                    <label for="videoUrl">Video URL*</label>
                    <input type="text" class="form-control" id="videoUrl" required>
                </div>
                <div class="form-group" style="display:flex; justify-content:space-between;">
                    <button type="button" class="btn btn-danger" id="cancelEpisodeButton">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Episode</button>
                </div>
            </form>
        </div>
    </div>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>DonghuaWave</h2>
                    <p>Admin Panel</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 DonghuaWave. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Supabase client
            const SUPABASE_URL = "https://xsofijbnzfiiteutpeza.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzb2ZpamJuemZpaXRldXRwZXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MTYyOTIsImV4cCI6MjA2MTk5MjI5Mn0.JEsqm4EHoCXYQHrlCIF4eL8e7oF2V5IFhxO1eSIzcbw";
            const supabase = supabaseCreateClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Elements
            const loading = document.getElementById('loading');
            const notification = document.getElementById('notification');
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');
            
            // Donghua elements
            const donghuaTable = document.getElementById('donghuaTable').querySelector('tbody');
            const donghuaFormModal = document.getElementById('donghuaFormModal');
            const donghuaForm = document.getElementById('donghuaForm');
            const modalTitle = document.getElementById('modalTitle');
            
            // Episode elements
            const donghuaSelect = document.getElementById('donghuaSelect');
            const episodesTable = document.getElementById('episodesTable');
            const episodeFormModal = document.getElementById('episodeFormModal');
            const episodeForm = document.getElementById('episodeForm');
            const addEpisodeButton = document.getElementById('addEpisodeButton');
            
            // Utility functions
            function showLoading() {
                loading.style.display = 'block';
            }
            
            function hideLoading() {
                loading.style.display = 'none';
            }
            
            function showNotification(message, type) {
                notification.textContent = message;
                notification.className = 'notification ' + type;
                notification.style.display = 'block';
                setTimeout(() => {
                    notification.style.display = 'none';
                }, 5000);
            }
            
            // Tab navigation
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tab = button.getAttribute('data-tab');
                    
                    // Update active tab button
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // Show active tab content
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById(tab + '-tab').classList.add('active');
                    
                    // Load data for the active tab
                    if (tab === 'donghua') {
                        loadDonghua();
                    } else if (tab === 'episodes') {
                        loadDonghuaForSelect();
                    } else if (tab === 'users') {
                        loadUsers();
                    }
                });
            });
            
            // Check authentication status
            async function checkAdminAuth() {
                const { data: { session } } = await supabase.auth.getSession();
                
                if (!session) {
                    window.location.href = 'login-admin.html';
                    return false;
                }
                
                // Check if user is admin
                const { data, error } = await supabase
                    .from('admins')
                    .select('*')
                    .eq('user_id', session.user.id)
                    .single();
                
                if (error || !data) {
                    window.location.href = 'login-admin.html';
                    return false;
                }
                
                return true;
            }
            
            // Donghua Management
            async function loadDonghua() {
                showLoading();
                try {
                    const { data, error } = await supabase
                        .from('donghua')
                        .select('*')
                        .order('title', { ascending: true });
                    
                    if (error) throw error;
                    
                    donghuaTable.innerHTML = '';
                    
                    if (data.length === 0) {
                        donghuaTable.innerHTML = `
                            <tr>
                                <td colspan="4" style="text-align:center;">No donghua found. Add one to get started.</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    data.forEach(donghua => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${donghua.title}</td>
                            <td>${donghua.year || 'N/A'}</td>
                            <td>${donghua.status || 'ongoing'}</td>
                            <td class="action-buttons">
                                <button class="btn btn-primary edit-donghua" data-id="${donghua.id}">Edit</button>
                                <button class="btn btn-danger delete-donghua" data-id="${donghua.id}" data-title="${donghua.title}">Delete</button>
                            </td>
                        `;
                        donghuaTable.appendChild(row);
                    });
                    
                    // Add event listeners to buttons
                    document.querySelectorAll('.edit-donghua').forEach(button => {
                        button.addEventListener('click', () => editDonghua(button.getAttribute('data-id')));
                    });
                    
                    document.querySelectorAll('.delete-donghua').forEach(button => {
                        button.addEventListener('click', () => {
                            const id = button.getAttribute('data-id');
                            const title = button.getAttribute('data-title');
                            if (confirm(`Are you sure you want to delete "${title}"? This will also delete all episodes.`)) {
                                deleteDonghua(id);
                            }
                        });
                    });
                } catch (error) {
                    console.error('Error loading donghua:', error);
                    showNotification('Failed to load donghua data.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Add new donghua button
            document.getElementById('newDonghuaButton').addEventListener('click', () => {
                resetDonghuaForm();
                modalTitle.textContent = 'Add New Donghua';
                document.getElementById('donghuaId').value = '';
                donghuaFormModal.style.display = 'block';
            });
            
            // Cancel donghua form
            document.getElementById('cancelDonghuaButton').addEventListener('click', () => {
                donghuaFormModal.style.display = 'none';
            });
            
            // Reset donghua form
            function resetDonghuaForm() {
                donghuaForm.reset();
                document.getElementById('donghuaId').value = '';
                document.getElementById('posterPreview').style.display = 'none';
                document.getElementById('genreTags').innerHTML = '';
                document.getElementById('genreValues').value = '';
            }
            
            // Edit donghua
            async function editDonghua(id) {
                showLoading();
                try {
                    const { data, error } = await supabase
                        .from('donghua')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (error) throw error;
                    
                    modalTitle.textContent = 'Edit Donghua: ' + data.title;
                    document.getElementById('donghuaId').value = data.id;
                    document.getElementById('title').value = data.title;
                    document.getElementById('year').value = data.year || '';
                    document.getElementById('status').value = data.status || 'ongoing';
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('posterUrl').value = data.poster_url || '';
                    
                    // Set genre tags
                    const genreTags = document.getElementById('genreTags');
                    genreTags.innerHTML = '';
                    const genreArray = data.genre || [];
                    document.getElementById('genreValues').value = JSON.stringify(genreArray);
                    
                    genreArray.forEach(genre => {
                        addGenreTag(genre);
                    });
                    
                    // Show poster preview if available
                    const posterPreview = document.getElementById('posterPreview');
                    if (data.poster_url) {
                        posterPreview.src = data.poster_url;
                        posterPreview.style.display = 'block';
                    } else {
                        posterPreview.style.display = 'none';
                    }
                    
                    donghuaFormModal.style.display = 'block';
                } catch (error) {
                    console.error('Error loading donghua details:', error);
                    showNotification('Failed to load donghua details.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Delete donghua
            async function deleteDonghua(id) {
                showLoading();
                try {
                    // First delete all episodes
                    const { error: episodesError } = await supabase
                        .from('episodes')
                        .delete()
                        .eq('donghua_id', id);
                    
                    if (episodesError) throw episodesError;
                    
                    // Then delete the donghua
                    const { error } = await supabase
                        .from('donghua')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    showNotification('Donghua successfully deleted.', 'success');
                    loadDonghua();
                } catch (error) {
                    console.error('Error deleting donghua:', error);
                    showNotification('Failed to delete donghua.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Poster URL preview
            document.getElementById('posterUrl').addEventListener('blur', function() {
                const url = this.value.trim();
                const posterPreview = document.getElementById('posterPreview');
                
                if (url) {
                    posterPreview.src = url;
                    posterPreview.onload = function() {
                        posterPreview.style.display = 'block';
                    };
                    posterPreview.onerror = function() {
                        posterPreview.style.display = 'none';
                        showNotification('Invalid image URL.', 'error');
                    };
                } else {
                    posterPreview.style.display = 'none';
                }
            });
            
            // Genre tags handling
            const genreInput = document.getElementById('genreInput');
            
            genreInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const genre = this.value.trim();
                    
                    if (genre) {
                        addGenreTag(genre);
                        this.value = '';
                        updateGenreValues();
                    }
                }
            });
            
            function addGenreTag(genre) {
                const tagsContainer = document.getElementById('genreTags');
                const tag = document.createElement('span');
                tag.className = 'tag';
                tag.innerHTML = `${genre} <span class="tag-remove">&times;</span>`;
                
                tag.querySelector('.tag-remove').addEventListener('click', function() {
                    tag.remove();
                    updateGenreValues();
                });
                
                tagsContainer.appendChild(tag);
            }
            
            function updateGenreValues() {
                const tags = Array.from(document.getElementById('genreTags').children).map(tag => {
                    // Extract the text without the "×" symbol
                    return tag.textContent.trim().replace('×', '').trim();
                });
                document.getElementById('genreValues').value = JSON.stringify(tags);
            }
            
            // Handle donghua form submission
            donghuaForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                showLoading();
                
                const id = document.getElementById('donghuaId').value;
                const title = document.getElementById('title').value;
                const year = document.getElementById('year').value;
                const status = document.getElementById('status').value;
                const description = document.getElementById('description').value;
                const posterUrl = document.getElementById('posterUrl').value;
                const genreValues = document.getElementById('genreValues').value;
                
                const donghuaData = {
                    title,
                    year: year ? parseInt(year) : null,
                    status,
                    description,
                    poster_url: posterUrl,
                    genre: genreValues ? JSON.parse(genreValues) : []
                };
                
                try {
                    let result;
                    
                    if (id) {
                        // Update existing donghua
                        result = await supabase
                            .from('donghua')
                            .update(donghuaData)
                            .eq('id', id);
                    } else {
                        // Create new donghua
                        result = await supabase
                            .from('donghua')
                            .insert([donghuaData]);
                    }
                    
                    if (result.error) throw result.error;
                    
                    showNotification(id ? 'Donghua updated successfully.' : 'New donghua added successfully.', 'success');
                    donghuaFormModal.style.display = 'none';
                    loadDonghua();
                } catch (error) {
                    console.error('Error saving donghua:', error);
                    showNotification('Failed to save donghua.', 'error');
                } finally {
                    hideLoading();
                }
            });
            
            // Episode Management
            async function loadDonghuaForSelect() {
                showLoading();
                try {
                    const { data, error } = await supabase
                        .from('donghua')
                        .select('id, title')
                        .order('title', { ascending: true });
                    
                    if (error) throw error;
                    
                    // Clear previous options except the default one
                    donghuaSelect.innerHTML = '<option value="">-- Select Donghua --</option>';
                    
                    data.forEach(donghua => {
                        const option = document.createElement('option');
                        option.value = donghua.id;
                        option.textContent = donghua.title;
                        donghuaSelect.appendChild(option);
                    });
                } catch (error) {
                    console.error('Error loading donghua list:', error);
                    showNotification('Failed to load donghua list.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Load episodes when donghua is selected
            donghuaSelect.addEventListener('change', function() {
                const donghuaId = this.value;
                
                if (donghuaId) {
                    loadEpisodes(donghuaId);
                    addEpisodeButton.style.display = 'block';
                } else {
                    episodesTable.style.display = 'none';
                    addEpisodeButton.style.display = 'none';
                }
            });
            
            async function loadEpisodes(donghuaId) {
                showLoading();
                try {
                    const { data, error } = await supabase
                        .from('episodes')
                        .select('*')
                        .eq('donghua_id', donghuaId)
                        .order('episode_number', { ascending: true });
                    
                    if (error) throw error;
                    
                    const tbody = episodesTable.querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align:center;">No episodes found. Add one to get started.</td>
                            </tr>
                        `;
                    } else {
                        data.forEach(episode => {
                            const row = document.createElement('tr');
                            row.innerHTML = `
                                <td>${episode.episode_number}</td>
                                <td>${episode.title}</td>
                                <td>${episode.duration || 'N/A'} min</td>
                                <td>${episode.is_premium ? 'Yes' : 'No'}</td>
                                <td class="action-buttons">
                                    <button class="btn btn-primary edit-episode" data-id="${episode.id}">Edit</button>
                                    <button class="btn btn-danger delete-episode" data-id="${episode.id}">Delete</button>
                                </td>
                            `;
                            tbody.appendChild(row);
                        });
                        
                        // Add event listeners to buttons
                        document.querySelectorAll('.edit-episode').forEach(button => {
                            button.addEventListener('click', () => editEpisode(button.getAttribute('data-id')));
                        });
                        
                        document.querySelectorAll('.delete-episode').forEach(button => {
                            button.addEventListener('click', () => {
                                const id = button.getAttribute('data-id');
                                if (confirm('Are you sure you want to delete this episode?')) {
                                    deleteEpisode(id);
                                }
                            });
                        });
                    }
                    
                    episodesTable.style.display = 'table';
                } catch (error) {
                    console.error('Error loading episodes:', error);
                    showNotification('Failed to load episodes.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Add new episode button
            addEpisodeButton.addEventListener('click', () => {
                resetEpisodeForm();
                document.getElementById('episodeModalTitle').textContent = 'Add New Episode';
                document.getElementById('episodeId').value = '';
                document.getElementById('episodeDonghuaId').value = donghuaSelect.value;
                episodeFormModal.style.display = 'block';
            });
            
            // Cancel episode form
            document.getElementById('cancelEpisodeButton').addEventListener('click', () => {
                episodeFormModal.style.display = 'none';
            });
            
            // Reset episode form
            function resetEpisodeForm() {
                episodeForm.reset();
                document.getElementById('episodeId').value = '';
                document.getElementById('thumbnailPreview').style.display = 'none';
            }
            
            // Edit episode
            async function editEpisode(id) {
                showLoading();
                try {
                    const { data, error } = await supabase
                        .from('episodes')
                        .select('*')
                        .eq('id', id)
                        .single();
                    
                    if (error) throw error;
                    
                    document.getElementById('episodeModalTitle').textContent = 'Edit Episode';
                    document.getElementById('episodeId').value = data.id;
                    document.getElementById('episodeDonghuaId').value = data.donghua_id;
                    document.getElementById('episodeNumber').value = data.episode_number;
                    document.getElementById('episodeTitle').value = data.title;
                    document.getElementById('duration').value = data.duration || '';
                    document.getElementById('isPremium').value = data.is_premium.toString();
                    document.getElementById('videoUrl').value = data.video_url;
                    document.getElementById('thumbnailUrl').value = data.thumbnail_url || '';
                    
                    // Show thumbnail preview if available
                    const thumbnailPreview = document.getElementById('thumbnailPreview');
                    if (data.thumbnail_url) {
                        thumbnailPreview.src = data.thumbnail_url;
                        thumbnailPreview.style.display = 'block';
                    } else {
                        thumbnailPreview.style.display = 'none';
                    }
                    
                    episodeFormModal.style.display = 'block';
                } catch (error) {
                    console.error('Error loading episode details:', error);
                    showNotification('Failed to load episode details.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Delete episode
            async function deleteEpisode(id) {
                showLoading();
                try {
                    // First delete any history records associated with this episode
                    const { error: historyError } = await supabase
                        .from('history')
                        .delete()
                        .eq('episode_id', id);
                    
                    if (historyError) throw historyError;
                    
                    // Then delete the episode
                    const { error } = await supabase
                        .from('episodes')
                        .delete()
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    showNotification('Episode successfully deleted.', 'success');
                    loadEpisodes(donghuaSelect.value);
                } catch (error) {
                    console.error('Error deleting episode:', error);
                    showNotification('Failed to delete episode.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Thumbnail URL preview
            document.getElementById('thumbnailUrl').addEventListener('blur', function() {
                const url = this.value.trim();
                const thumbnailPreview = document.getElementById('thumbnailPreview');
                
                if (url) {
                    thumbnailPreview.src = url;
                    thumbnailPreview.onload = function() {
                        thumbnailPreview.style.display = 'block';
                    };
                    thumbnailPreview.onerror = function() {
                        thumbnailPreview.style.display = 'none';
                        showNotification('Invalid image URL.', 'error');
                    };
                } else {
                    thumbnailPreview.style.display = 'none';
                }
            });
            
            // Handle episode form submission
            episodeForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                showLoading();
                
                const id = document.getElementById('episodeId').value;
                const donghuaId = document.getElementById('episodeDonghuaId').value;
                const episodeNumber = document.getElementById('episodeNumber').value;
                const title = document.getElementById('episodeTitle').value;
                const duration = document.getElementById('duration').value;
                const isPremium = document.getElementById('isPremium').value === 'true';
                const videoUrl = document.getElementById('videoUrl').value;
                const thumbnailUrl = document.getElementById('thumbnailUrl').value;
                
                const episodeData = {
                    donghua_id: donghuaId,
                    episode_number: parseInt(episodeNumber),
                    title,
                    duration: duration ? parseInt(duration) : null,
                    is_premium: isPremium,
                    video_url: videoUrl,
                    thumbnail_url: thumbnailUrl || null
                };
                
                try {
                    let result;
                    
                    if (id) {
                        // Update existing episode
                        result = await supabase
                            .from('episodes')
                            .update(episodeData)
                            .eq('id', id);
                    } else {
                        // Create new episode
                        result = await supabase
                            .from('episodes')
                            .insert([episodeData]);
                    }
                    
                    if (result.error) throw result.error;
                    
                    showNotification(id ? 'Episode updated successfully.' : 'New episode added successfully.', 'success');
                    episodeFormModal.style.display = 'none';
                    loadEpisodes(donghuaId);
                } catch (error) {
                    console.error('Error saving episode:', error);
                    showNotification('Failed to save episode.', 'error');
                } finally {
                    hideLoading();
                }
            });
            
            // Users Management
            async function loadUsers() {
                showLoading();
                try {
                    const { data, error } = await supabase
                        .from('users')
                        .select('*')
                        .order('created_at', { ascending: false });
                    
                    if (error) throw error;
                    
                    const tbody = document.getElementById('usersTable').querySelector('tbody');
                    tbody.innerHTML = '';
                    
                    if (data.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="5" style="text-align:center;">No users found.</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    // Check which users are VIP
                    const { data: vipUsers, error: vipError } = await supabase
                        .from('vip_users')
                        .select('user_id');
                    
                    if (vipError) throw vipError;
                    
                    const vipUserIds = vipUsers.map(vip => vip.user_id);
                    
                    data.forEach(user => {
                        const row = document.createElement('tr');
                        const isVip = vipUserIds.includes(user.user_id);
                        
                        row.innerHTML = `
                            <td>${user.name || 'N/A'}</td>
                            <td>${user.email || 'N/A'}</td>
                            <td>${isVip ? 'VIP' : user.status}</td>
                            <td>${new Date(user.created_at).toLocaleDateString()}</td>
                            <td class="action-buttons">
                                <button class="btn ${isVip ? 'btn-danger remove-vip' : 'btn-primary make-vip'}" data-id="${user.user_id}">
                                    ${isVip ? 'Remove VIP' : 'Make VIP'}
                                </button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // Add event listeners to buttons
                    document.querySelectorAll('.make-vip').forEach(button => {
                        button.addEventListener('click', () => makeUserVip(button.getAttribute('data-id')));
                    });
                    
                    document.querySelectorAll('.remove-vip').forEach(button => {
                        button.addEventListener('click', () => removeUserVip(button.getAttribute('data-id')));
                    });
                } catch (error) {
                    console.error('Error loading users:', error);
                    showNotification('Failed to load users.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Make a user VIP
            async function makeUserVip(userId) {
                showLoading();
                try {
                    // Get user details
                    const { data: userData, error: userError } = await supabase
                        .from('users')
                        .select('*')
                        .eq('user_id', userId)
                        .single();
                    
                    if (userError) throw userError;
                    
                    // Create VIP entry
                    const { error } = await supabase
                        .from('vip_users')
                        .insert([{
                            user_id: userId,
                            name: userData.name,
                            email: userData.email,
                            subscription_start: new Date().toISOString(),
                            subscription_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
                        }]);
                    
                    if (error) throw error;
                    
                    showNotification('User has been granted VIP status.', 'success');
                    loadUsers();
                } catch (error) {
                    console.error('Error making user VIP:', error);
                    showNotification('Failed to update user status.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Remove VIP status from user
            async function removeUserVip(userId) {
                showLoading();
                try {
                    const { error } = await supabase
                        .from('vip_users')
                        .delete()
                        .eq('user_id', userId);
                    
                    if (error) throw error;
                    
                    showNotification('VIP status removed from user.', 'success');
                    loadUsers();
                } catch (error) {
                    console.error('Error removing VIP status:', error);
                    showNotification('Failed to update user status.', 'error');
                } finally {
                    hideLoading();
                }
            }
            
            // Logout button
            document.getElementById('adminLogoutButton').addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.href = 'login-admin.html';
            });
            
            // Supabase createClient wrapper to avoid conflicts with global supabase variable
            function supabaseCreateClient(url, key) {
                return window.supabase.createClient(url, key);
            }
            
            // Check authentication and load initial data
            checkAdminAuth().then(isAdmin => {
                if (isAdmin) {
                    loadDonghua();
                }
            });
        });
    </script>
</body>
</html>
