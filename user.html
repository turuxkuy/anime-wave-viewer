<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DonghuaWave - User Dashboard</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <h1>DonghuaWave</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="user.html">Home</a></li>
                    <li><a href="#">New Releases</a></li>
                    <li><a href="#">Popular</a></li>
                    <li><a href="#">Genres</a></li>
                </ul>
            </nav>
            <div class="user-actions">
                <div class="search-box">
                    <input type="text" placeholder="Search...">
                    <button><i class="fas fa-search"></i></button>
                </div>
                <div class="user-menu">
                    <button class="user-menu-btn">
                        <img src="https://via.placeholder.com/40" alt="User" class="avatar" id="user-avatar">
                        <span id="user-name">User</span>
                        <i class="fas fa-chevron-down"></i>
                    </button>
                    <div class="user-dropdown">
                        <ul>
                            <li><a href="user.html"><i class="fas fa-user"></i> Dashboard</a></li>
                            <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                            <li><a href="#" id="logout-btn"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <main class="dashboard">
        <div class="container">
            <h1>User Dashboard</h1>
            <div class="dashboard-grid">
                <div class="dashboard-sidebar">
                    <div class="user-info">
                        <img src="https://via.placeholder.com/100" alt="User Avatar" class="user-avatar">
                        <h2 id="sidebar-username">User Name</h2>
                        <p class="user-email" id="user-email">user@example.com</p>
                        <div id="user-status" class="user-status free">Free User</div>
                        <button class="btn-upgrade" id="btn-upgrade">Upgrade to VIP</button>
                    </div>
                    <div class="sidebar-menu">
                        <ul>
                            <li class="active"><a href="#account"><i class="fas fa-user"></i> Account</a></li>
                            <li><a href="#bookmarks"><i class="fas fa-bookmark"></i> Bookmarks</a></li>
                            <li><a href="#history"><i class="fas fa-history"></i> Watch History</a></li>
                            <li><a href="#settings"><i class="fas fa-cog"></i> Settings</a></li>
                        </ul>
                    </div>
                </div>
                <div class="dashboard-content">
                    <section id="account" class="dashboard-section active">
                        <h2>Account Information</h2>
                        <div class="account-details">
                            <div class="detail-row">
                                <span class="detail-label">Username:</span>
                                <span class="detail-value">User123</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Email:</span>
                                <span class="detail-value">user@example.com</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Account Type:</span>
                                <span class="detail-value">Free</span>
                            </div>
                            <div class="detail-row">
                                <span class="detail-label">Joined:</span>
                                <span class="detail-value">May 1, 2025</span>
                            </div>
                        </div>
                        <div class="account-actions">
                            <button class="btn-secondary">Edit Profile</button>
                            <button class="btn-secondary">Change Password</button>
                        </div>
                    </section>
                    
                    <section id="bookmarks" class="dashboard-section">
                        <h2>Your Bookmarks</h2>
                        <div class="donghua-grid">
                            <!-- Bookmark items will be inserted here -->
                        </div>
                    </section>
                    
                    <section id="history" class="dashboard-section">
                        <h2>Watch History</h2>
                        <div class="history-list">
                            <!-- History items will be inserted here -->
                        </div>
                    </section>

                    <section id="settings" class="dashboard-section">
                        <h2>Account Settings</h2>
                        <form class="settings-form">
                            <div class="form-group">
                                <label for="notification">Notifications</label>
                                <div class="toggle">
                                    <input type="checkbox" id="notification" checked>
                                    <label for="notification" class="toggle-label"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="autoplay">Autoplay Next Episode</label>
                                <div class="toggle">
                                    <input type="checkbox" id="autoplay" checked>
                                    <label for="autoplay" class="toggle-label"></label>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="quality">Default Video Quality</label>
                                <select id="quality">
                                    <option value="auto">Auto</option>
                                    <option value="1080p">1080p</option>
                                    <option value="720p">720p</option>
                                    <option value="480p">480p</option>
                                    <option value="360p">360p</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn-primary">Save Settings</button>
                            </div>
                        </form>
                    </section>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <h2>DonghuaWave</h2>
                    <p>Your premier destination for Chinese animation</p>
                </div>
                <div class="footer-links">
                    <div class="footer-column">
                        <h3>Navigation</h3>
                        <ul>
                            <li><a href="user.html">Home</a></li>
                            <li><a href="#">New Releases</a></li>
                            <li><a href="#">Popular</a></li>
                            <li><a href="#">Genres</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Account</h3>
                        <ul>
                            <li><a href="user.html">Dashboard</a></li>
                            <li><a href="#">Settings</a></li>
                            <li><a href="#">Upgrade to VIP</a></li>
                        </ul>
                    </div>
                    <div class="footer-column">
                        <h3>Legal</h3>
                        <ul>
                            <li><a href="#">Terms of Service</a></li>
                            <li><a href="#">Privacy Policy</a></li>
                            <li><a href="#">Copyright</a></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 DonghuaWave. All rights reserved.</p>
                <div class="social-links">
                    <a href="#"><i class="fab fa-facebook"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-discord"></i></a>
                </div>
            </div>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Initialize Supabase client
            const SUPABASE_URL = "https://xsofijbnzfiiteutpeza.supabase.co";
            const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inhzb2ZpamJuemZpaXRldXRwZXphIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY0MTYyOTIsImV4cCI6MjA2MTk5MjI5Mn0.JEsqm4EHoCXYQHrlCIF4eL8e7oF2V5IFhxO1eSIzcbw";
            const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Check if user is logged in
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            
            if (sessionError || !session) {
                // User is not logged in, redirect to login page
                window.location.href = 'login.html?redirect=user';
                return;
            }
            
            const user = session.user;
            
            // Update user information in the UI
            document.getElementById('user-name').textContent = user.user_metadata.name || user.email.split('@')[0];
            document.getElementById('sidebar-username').textContent = user.user_metadata.name || user.email.split('@')[0];
            document.getElementById('user-email').textContent = user.email;
            
            // Check if user is VIP
            const { data: vipData } = await supabase
                .from('vip_users')
                .select('id, subscription_end')
                .eq('user_id', user.id)
                .single();
                
            if (vipData) {
                // User is VIP
                const userStatus = document.getElementById('user-status');
                userStatus.textContent = 'VIP User';
                userStatus.classList.remove('free');
                userStatus.classList.add('vip');
                
                // Hide upgrade button
                document.getElementById('btn-upgrade').style.display = 'none';
                
                // Check if subscription is active
                const now = new Date();
                const subscriptionEnd = vipData.subscription_end ? new Date(vipData.subscription_end) : null;
                
                if (subscriptionEnd && subscriptionEnd < now) {
                    // Subscription expired
                    userStatus.textContent = 'VIP Expired';
                    userStatus.classList.remove('vip');
                    userStatus.classList.add('expired');
                    document.getElementById('btn-upgrade').style.display = 'block';
                    document.getElementById('btn-upgrade').textContent = 'Renew VIP';
                }
            }

            // Toggle user dropdown menu
            const userMenuBtn = document.querySelector('.user-menu-btn');
            const userDropdown = document.querySelector('.user-dropdown');
            
            userMenuBtn.addEventListener('click', () => {
                userDropdown.classList.toggle('active');
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.user-menu')) {
                    userDropdown.classList.remove('active');
                }
            });

            // Handle logout
            const logoutBtn = document.getElementById('logout-btn');
            logoutBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                
                // Logout from Supabase
                await supabase.auth.signOut();
                
                // Redirect to home page
                window.location.href = 'index.html';
            });

            // Tab navigation
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            const dashboardSections = document.querySelectorAll('.dashboard-section');
            
            sidebarLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all links and sections
                    sidebarLinks.forEach(l => l.parentElement.classList.remove('active'));
                    dashboardSections.forEach(s => s.classList.remove('active'));
                    
                    // Add active class to clicked link
                    link.parentElement.classList.add('active');
                    
                    // Show corresponding section
                    const targetId = link.getAttribute('href').substring(1);
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // Load bookmarks
            const loadBookmarks = async () => {
                const { data: bookmarks, error: bookmarksError } = await supabase
                    .from('bookmarks')
                    .select(`
                        id,
                        donghua:donghua_id (
                            id,
                            title,
                            poster_url
                        )
                    `)
                    .eq('user_id', user.id);

                if (bookmarksError) {
                    console.error('Error loading bookmarks:', bookmarksError);
                    return;
                }

                const bookmarkGrid = document.querySelector('#bookmarks .donghua-grid');
                let bookmarkHTML = '';
                
                if (bookmarks && bookmarks.length > 0) {
                    bookmarks.forEach(bookmark => {
                        const donghua = bookmark.donghua;
                        bookmarkHTML += `
                            <div class="donghua-card" data-id="${donghua.id}">
                                <div class="poster">
                                    <img src="${donghua.poster_url || 'https://via.placeholder.com/300x450?text=' + encodeURIComponent(donghua.title)}" alt="${donghua.title}">
                                    <div class="overlay">
                                        <a href="donghua.html?id=${donghua.id}" class="btn-watch">View</a>
                                    </div>
                                </div>
                                <div class="donghua-info">
                                    <h3>${donghua.title}</h3>
                                    <div class="actions">
                                        <button class="btn-icon remove-bookmark" data-id="${bookmark.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    bookmarkHTML = '<p class="empty-state">You have no bookmarks yet.</p>';
                }
                
                bookmarkGrid.innerHTML = bookmarkHTML;
                
                // Add event listeners for bookmark removal
                const removeButtons = document.querySelectorAll('.remove-bookmark');
                removeButtons.forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const bookmarkId = button.getAttribute('data-id');
                        
                        const { error: deleteError } = await supabase
                            .from('bookmarks')
                            .delete()
                            .eq('id', bookmarkId);
                            
                        if (!deleteError) {
                            // Remove card from UI
                            const card = button.closest('.donghua-card');
                            card.remove();
                            
                            // Show empty state if no more bookmarks
                            if (document.querySelectorAll('.donghua-card').length === 0) {
                                bookmarkGrid.innerHTML = '<p class="empty-state">You have no bookmarks yet.</p>';
                            }
                        }
                    });
                });
            };

            // Load watch history
            const loadHistory = async () => {
                const { data: history, error: historyError } = await supabase
                    .from('history')
                    .select(`
                        id,
                        progress,
                        is_completed,
                        watched_at,
                        episode:episode_id (
                            id,
                            title,
                            episode_number,
                            thumbnail_url,
                            donghua_id,
                            donghua:donghua_id (
                                title
                            )
                        )
                    `)
                    .eq('user_id', user.id)
                    .order('watched_at', { ascending: false })
                    .limit(10);

                if (historyError) {
                    console.error('Error loading history:', historyError);
                    return;
                }

                const historyList = document.querySelector('#history .history-list');
                let historyHTML = '';
                
                if (history && history.length > 0) {
                    history.forEach(item => {
                        const episode = item.episode;
                        const donghuaTitle = episode?.donghua?.title || 'Unknown Donghua';
                        const episodeTitle = episode?.title || `Episode ${episode?.episode_number || 'Unknown'}`;
                        const thumbnailUrl = episode?.thumbnail_url || 'https://via.placeholder.com/120x70?text=No+Thumbnail';
                        
                        const watchedDate = new Date(item.watched_at);
                        const today = new Date();
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        
                        let watchedDisplay;
                        if (watchedDate.toDateString() === today.toDateString()) {
                            watchedDisplay = `Today, ${watchedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                        } else if (watchedDate.toDateString() === yesterday.toDateString()) {
                            watchedDisplay = `Yesterday, ${watchedDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
                        } else {
                            watchedDisplay = watchedDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
                        }
                        
                        historyHTML += `
                            <div class="history-item">
                                <div class="history-poster">
                                    <img src="${thumbnailUrl}" alt="${episodeTitle}">
                                </div>
                                <div class="history-details">
                                    <h4>${donghuaTitle}</h4>
                                    <p>${episodeTitle}</p>
                                    <div class="history-meta">
                                        <span class="watched-at">${watchedDisplay}</span>
                                        <div class="progress-bar">
                                            <div class="progress" style="width: ${item.progress}%"></div>
                                        </div>
                                    </div>
                                </div>
                                <div class="history-actions">
                                    <a href="episode.html?id=${episode.id}" class="btn-resume">
                                        <i class="fas fa-play"></i>
                                    </a>
                                    <button class="btn-icon remove-history" data-id="${item.id}">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                } else {
                    historyHTML = '<p class="empty-state">Your watch history is empty.</p>';
                }
                
                historyList.innerHTML = historyHTML;
                
                // Add event listeners for history removal
                const removeButtons = document.querySelectorAll('.remove-history');
                removeButtons.forEach(button => {
                    button.addEventListener('click', async (e) => {
                        const historyId = button.getAttribute('data-id');
                        
                        const { error: deleteError } = await supabase
                            .from('history')
                            .delete()
                            .eq('id', historyId);
                            
                        if (!deleteError) {
                            // Remove item from UI
                            const item = button.closest('.history-item');
                            item.remove();
                            
                            // Show empty state if no more history
                            if (document.querySelectorAll('.history-item').length === 0) {
                                historyList.innerHTML = '<p class="empty-state">Your watch history is empty.</p>';
                            }
                        }
                    });
                });
            };

            // Load user data
            loadBookmarks();
            loadHistory();
            
            // Handle upgrade to VIP button
            const upgradeBtn = document.getElementById('btn-upgrade');
            upgradeBtn.addEventListener('click', async () => {
                alert('VIP upgrade functionality will be implemented here. This would typically integrate with a payment processor like Stripe.');
                
                // For demo purposes, let's simulate upgrading the user to VIP
                const { error } = await supabase
                    .from('vip_users')
                    .upsert({
                        user_id: user.id,
                        name: user.user_metadata.name,
                        email: user.email,
                        subscription_start: new Date().toISOString(),
                        subscription_end: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString() // 30 days from now
                    });
                    
                if (!error) {
                    // Refresh page to update UI
                    window.location.reload();
                }
            });
        });
    </script>
</body>
</html>
